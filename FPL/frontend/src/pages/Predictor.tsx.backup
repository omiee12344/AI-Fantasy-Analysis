// src/pages/Predictor.tsx
import { useState, useEffect } from 'react';
import React from 'react';
import { Search, X, ChevronDown } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import API, { type LivePlayer } from '@/lib/api';
import { getPlayerImageSources } from '@/lib/playerImages';

// Enhanced player type for predictor
type PredictorPlayer = {
  id: number;
  name: string;
  team: string;
  position: string;
  price: number;
  selectionPercent: string;
  predictedPoints: number; // xPts (calculated)
  form: number;
  stats: {
    goals: number;
    assists: number;
    bonus: number;
    points: number;
    minutes: number;
  };
  analysis: string;
};

// Filter options
const TEAM_OPTIONS = [
  { value: 'all', label: 'All Teams' },
  { value: 'ARS', label: 'Arsenal' },
  { value: 'AVL', label: 'Aston Villa' },
  { value: 'BOU', label: 'Bournemouth' },
  { value: 'BRE', label: 'Brentford' },
  { value: 'BHA', label: 'Brighton' },
  { value: 'CHE', label: 'Chelsea' },
  { value: 'CRY', label: 'Crystal Palace' },
  { value: 'EVE', label: 'Everton' },
  { value: 'FUL', label: 'Fulham' },
  { value: 'LIV', label: 'Liverpool' },
  { value: 'LUT', label: 'Luton Town' },
  { value: 'MCI', label: 'Man City' },
  { value: 'MUN', label: 'Man United' },
  { value: 'NEW', label: 'Newcastle' },
  { value: 'NFO', label: "Nott'm Forest" },
  { value: 'SHU', label: 'Sheffield Utd' },
  { value: 'TOT', label: 'Tottenham' },
  { value: 'WHU', label: 'West Ham' },
  { value: 'WOL', label: 'Wolves' }
];

const POSITION_OPTIONS = [
  { value: 'all', label: 'All Positions' },
  { value: 'GKP', label: 'Goalkeepers' },
  { value: 'DEF', label: 'Defenders' },
  { value: 'MID', label: 'Midfielders' },
  { value: 'FWD', label: 'Forwards' }
];

const PRICE_OPTIONS = [
  { value: 'all', label: 'Any Price' },
  { value: '4.0-5.0', label: '£4.0m - £5.0m' },
  { value: '5.0-6.5', label: '£5.0m - £6.5m' },
  { value: '6.5-8.0', label: '£6.5m - £8.0m' },
  { value: '8.0-10.0', label: '£8.0m - £10.0m' },
  { value: '10.0-12.0', label: '£10.0m - £12.0m' },
  { value: '12.0+', label: '£12.0m+' }
];

// Helper function to convert LivePlayer to PredictorPlayer
const convertToPredictorPlayer = (livePlayer: LivePlayer): PredictorPlayer => {
  const price = (livePlayer.now_cost || 0) / 10;
  const form = parseFloat(livePlayer.form || '0');
  const totalPoints = livePlayer.total_points || 0;
  
  // Simple predicted points calculation (can be enhanced with ML later)
  const predictedPoints = Math.max(0, form * 1.2 + (totalPoints / 10));
  
  // Generate AI analysis based on player stats
  const generateAnalysis = (player: LivePlayer): string => {
    const points = player.total_points || 0;
    const form = parseFloat(player.form || '0');
    const price = (player.now_cost || 0) / 10;
    
    if (points > 150 && form > 7) {
      return `${player.name} is in excellent form and consistently delivers high points. A premium option worth considering for your FPL team.`;
    } else if (points > 100 && price < 7) {
      return `${player.name} offers great value for money with solid returns. An ideal mid-range option for balanced squads.`;
    } else if (form > 8) {
      return `${player.name} is currently in exceptional form and could be a differential pick with high upside potential.`;
    } else if (points > 80) {
      return `${player.name} has shown consistent performance this season. A reliable option for steady points accumulation.`;
    } else {
      return `${player.name} is a budget-friendly option. Monitor their fixtures and form for potential value plays.`;
    }
  };
  
  return {
    id: livePlayer.id,
    name: livePlayer.name,
    team: livePlayer.team,
    position: livePlayer.pos,
    price,
    selectionPercent: `${parseFloat(livePlayer.selected_by_percent || '0').toFixed(1)}%`,
    predictedPoints: parseFloat(predictedPoints.toFixed(1)),
    form,
    stats: {
      goals: 0, // These would come from detailed stats API
      assists: 0,
      bonus: 0,
      points: totalPoints,
      minutes: livePlayer.minutes || 0
    },
    analysis: generateAnalysis(livePlayer)
  };
};

// Reusable StatDisplay component
const StatDisplay = ({ label, value }: { label: string; value: string | number }) => (
  <div className="flex justify-between items-center py-2 border-b border-white/10 last:border-none">
    <span className="text-sm text-white/70">{label}</span>
    <span className="font-bold text-md">{value}</span>
  </div>
);

// Component to display a single player's card
const PlayerCard = ({ player }: { player: PredictorPlayer | null }) => {
  if (!player) {
    return (
      <div className="flex items-center justify-center h-full bg-white/5 rounded-lg p-4 min-h-[300px]">
        <p className="text-white/70">Select a player</p>
      </div>
    );
  }
  return (
    <div>
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center">
          <img src={`/logos/${player.team}.png`} alt={player.team} className="w-10 h-10 mr-4" />
          <div>
            <h2 className="text-2xl font-bold">{player.name}</h2>
            <p className="text-white/70 text-sm">{player.team} - {player.position}</p>
          </div>
        </div>
      </div>
      <Separator className="bg-white/10" />
      <div className="mt-4">
        <div className="grid grid-cols-2 gap-x-8 gap-y-2">
          <StatDisplay label="Price" value={`£${player.price.toFixed(1)}m`} />
          <StatDisplay label="Sel. by" value={player.selectionPercent} />
          <StatDisplay label="xPts" value={player.predictedPoints.toFixed(1)} />
          <StatDisplay label="Form" value={player.form.toFixed(1)} />
          <StatDisplay label="Goals" value={player.stats.goals} />
          <StatDisplay label="Assists" value={player.stats.assists} />
          <StatDisplay label="Bonus" value={player.stats.bonus} />
          <StatDisplay label="Points" value={player.stats.points} />
        </div>
      </div>
    </div>
  );
};


export default function Predictor() {
  const [searchQuery, setSearchQuery] = useState('');
  const [players, setPlayers] = useState<PredictorPlayer[]>([]);
  const [selectedPlayer, setSelectedPlayer] = useState<PredictorPlayer | null>(null);
  const [comparisonPlayers, setComparisonPlayers] = useState<(PredictorPlayer | null)[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Filter states
  const [teamFilter, setTeamFilter] = useState('all');
  const [positionFilter, setPositionFilter] = useState('all');
  const [priceFilter, setPriceFilter] = useState('all');

  // Fetch players from API
  useEffect(() => {
    const fetchPlayers = async () => {
      try {
        setLoading(true);
        setError(null);
        const response = await API.players();
        const predictorPlayers = response.players.map(convertToPredictorPlayer);
        
        // Sort by total points descending
        predictorPlayers.sort((a, b) => b.stats.points - a.stats.points);
        
        setPlayers(predictorPlayers);
        setSelectedPlayer(predictorPlayers[0] || null);
      } catch (err: any) {
        console.error('Failed to fetch players:', err);
        setError(err?.message || 'Failed to load players');
      } finally {
        setLoading(false);
      }
    };
    
    fetchPlayers();
  }, []);

  const isComparing = comparisonPlayers.length > 0;

  // Helper function to check price filter
  const matchesPriceFilter = (price: number): boolean => {
    switch (priceFilter) {
      case '4.0-5.0': return price >= 4.0 && price <= 5.0;
      case '5.0-6.5': return price >= 5.0 && price <= 6.5;
      case '6.5-8.0': return price >= 6.5 && price <= 8.0;
      case '8.0-10.0': return price >= 8.0 && price <= 10.0;
      case '10.0-12.0': return price >= 10.0 && price <= 12.0;
      case '12.0+': return price >= 12.0;
      default: return true;
    }
  };

  const handleSelectPlayer = (player: PredictorPlayer) => {
    if (isComparing) {
      if (comparisonPlayers.length === 1 && comparisonPlayers[0]?.id !== player.id) {
        setComparisonPlayers([comparisonPlayers[0], player]);
      }
    } else {
      setSelectedPlayer(player);
    }
  };

  const handleComparisonClick = () => {
    if (isComparing) {
      setSelectedPlayer(comparisonPlayers[0]);
      setComparisonPlayers([]);
    } else if (selectedPlayer) {
      setComparisonPlayers([selectedPlayer]);
    }
  };

  const filteredPlayers = players.filter(player => {
    // Search filter
    const matchesSearch = player.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                         player.team.toLowerCase().includes(searchQuery.toLowerCase());
    
    // Team filter
    const matchesTeam = teamFilter === 'all' || player.team === teamFilter;
    
    // Position filter
    const matchesPosition = positionFilter === 'all' || player.position === positionFilter;
    
    // Price filter
    const matchesPrice = matchesPriceFilter(player.price);
    
    return matchesSearch && matchesTeam && matchesPosition && matchesPrice;
  });
  
  // Reset filters
  const resetFilters = () => {
    setTeamFilter('all');
    setPositionFilter('all');
    setPriceFilter('all');
    setSearchQuery('');
  };
  
  if (loading) {
    return (
      <div className="min-h-screen bg-[#37003c] text-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-pulse">
            <div className="h-8 w-64 bg-white/20 rounded mb-4 mx-auto" />
            <div className="h-4 w-48 bg-white/10 rounded mx-auto" />
          </div>
          <p className="mt-4 text-white/70">Loading players...</p>
        </div>
      </div>
    );
  }
  
  if (error) {
    return (
      <div className="min-h-screen bg-[#37003c] text-white flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-2xl font-bold mb-4">Failed to Load Players</h1>
          <p className="text-red-300 mb-4">{error}</p>
          <Button onClick={() => window.location.reload()} className="bg-[#04d27f] hover:bg-[#03b86f] text-black">
            Try Again
          </Button>
        </div>
      </div>
    );
  }

  const getComparisonAnalysis = () => {
    if (comparisonPlayers.length === 2 && comparisonPlayers[0] && comparisonPlayers[1]) {
      const [p1, p2] = comparisonPlayers;
      if (p1.predictedPoints > p2.predictedPoints) {
        return `${p1.name} has a higher xPts and is expected to outperform ${p2.name}. ${p1.analysis}`;
      }
      return `${p2.name} is projected to score more points than ${p1.name}. ${p2.analysis}`;
    }
    return "Select a second player to generate the AI comparison.";
  }

  return (
    <div className="min-h-screen bg-[#37003c] text-white">
      <div className="px-4 sm:px-6 lg:px-8 py-8">
        <header className="text-center mb-10">
          <h1 className="text-5xl font-bold mb-2">AI Player Analyzer</h1>
          <p className="text-lg text-white/80">
            Search, compare, and get detailed insights on players.
          </p>
        </header>

        <div className="flex flex-col lg:flex-row gap-8">
          {/* Left Side: Player List & Filters (40%) */}
          <div className="w-full lg:w-2/5 flex flex-col">
            <div className="flex gap-2 mb-4 items-center">
              <div className="relative flex-grow">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/50" />
                <Input
                  type="text"
                  placeholder={isComparing ? "Select a player to compare" : "Search players..."}
                  className="w-full bg-white/10 border-none pl-9 h-10 text-sm text-white placeholder:text-white/50"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>
              {!isComparing && (
                <Button 
                  variant="outline" 
                  className="bg-white/10 border-none h-9 text-xs px-3 hover:bg-white/20"
                  onClick={resetFilters}
                >
                  Reset
                </Button>
              )}
            </div>
            
            {/* Filter Dropdowns */}
            {!isComparing && (
              <div className="flex gap-2 mb-4">
                <Select value={teamFilter} onValueChange={setTeamFilter}>
                  <SelectTrigger className="bg-white/10 border-none text-white h-9 text-xs flex-1">
                    <SelectValue placeholder="Team" />
                  </SelectTrigger>
                  <SelectContent className="bg-[#2a0f32] border-white/20">
                    {TEAM_OPTIONS.map(option => (
                      <SelectItem 
                        key={option.value} 
                        value={option.value}
                        className="text-white focus:bg-white/10 text-xs"
                      >
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                
                <Select value={positionFilter} onValueChange={setPositionFilter}>
                  <SelectTrigger className="bg-white/10 border-none text-white h-9 text-xs flex-1">
                    <SelectValue placeholder="Position" />
                  </SelectTrigger>
                  <SelectContent className="bg-[#2a0f32] border-white/20">
                    {POSITION_OPTIONS.map(option => (
                      <SelectItem 
                        key={option.value} 
                        value={option.value}
                        className="text-white focus:bg-white/10 text-xs"
                      >
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                
                <Select value={priceFilter} onValueChange={setPriceFilter}>
                  <SelectTrigger className="bg-white/10 border-none text-white h-9 text-xs flex-1">
                    <SelectValue placeholder="Price" />
                  </SelectTrigger>
                  <SelectContent className="bg-[#2a0f32] border-white/20">
                    {PRICE_OPTIONS.map(option => (
                      <SelectItem 
                        key={option.value} 
                        value={option.value}
                        className="text-white focus:bg-white/10 text-xs"
                      >
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            )}

            <ScrollArea className="bg-white/5 rounded-lg h-[60vh]">
              <div className="p-2 space-y-1">
                {filteredPlayers.map(player => (
                  <div
                    key={player.id}
                    className={`p-3 rounded-md cursor-pointer transition-colors 
                      ${selectedPlayer?.id === player.id && !isComparing ? 'bg-white/20' : 'hover:bg-white/10'}
                      ${comparisonPlayers.find(p => p?.id === player.id) ? 'bg-purple-500/40' : ''}
                    `}
                    onClick={() => handleSelectPlayer(player)}
                  >
                    <div className="flex items-center gap-3">
                      {/* Player Image */}
                      <PlayerImageComponent playerId={player.id} playerName={player.name} teamName={player.team} />
                      
                      <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start">
                          <div className="min-w-0 flex-1">
                            <div className="font-bold truncate">{player.name}</div>
                            <div className="text-xs text-white/70">{player.team} - {player.position}</div>
                          </div>
                          <div className="text-right ml-2">
                            <div className="font-bold">£{player.price.toFixed(1)}m</div>
                            <div className="text-xs text-white/70">xPts: {player.predictedPoints}</div>
                          </div>
                        </div>
                        <div className="flex justify-between items-center mt-1 text-xs text-white/50">
                          <span>{player.stats.points} pts</span>
                          <span>Form: {player.form.toFixed(1)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
                {filteredPlayers.length === 0 && (
                  <div className="text-center py-8 text-white/60">
                    <p className="mb-2">No players found matching your criteria</p>
                    <Button 
                      onClick={resetFilters}
                      variant="outline"
                      size="sm"
                      className="bg-white/10 border-white/20 text-white hover:bg-white/20"
                    >
                      Clear Filters
                    </Button>
                  </div>
                )}
              </div>
            </ScrollArea>
          </div>

          {/* Right Side: Player Details (60%) */}
          <div className="w-full lg:w-3/5">
            <div className="bg-white/5 rounded-lg p-6 h-full">
              {/* Comparison View */}
              {isComparing ? (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold">Player Comparison</h2>
                    <Button onClick={handleComparisonClick} variant="destructive" size="sm">
                      <X className="w-4 h-4 mr-2" />
                      Cancel Comparison
                    </Button>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2">
                    <div className="pr-6">
                        <PlayerCard player={comparisonPlayers[0]} />
                    </div>
                    <div className="pl-6 border-l border-white/10">
                        <PlayerCard player={comparisonPlayers[1]} />
                    </div>
                  </div>
                  
                  <Separator className="bg-white/10 my-4" />
                  <div>
                    <h3 className="text-lg font-semibold mb-2">AI Comparison</h3>
                    <p className="text-white/80 text-sm">{getComparisonAnalysis()}</p>
                  </div>
                </div>
              ) : (
                /* Single Player View */
                <div>
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center">
                      <img src={`/logos/${selectedPlayer?.team}.png`} alt={selectedPlayer?.team} className="w-10 h-10 mr-4" />
                      <div>
                        <h2 className="text-2xl font-bold">{selectedPlayer?.name}</h2>
                        <p className="text-white/70 text-sm">{selectedPlayer?.team} - {selectedPlayer?.position}</p>
                      </div>
                    </div>
                    <Button onClick={handleComparisonClick} variant="outline" className="bg-white/10 border-none h-9 text-xs px-4">
                      Add to Comparison
                    </Button>
                  </div>

                  <Separator className="bg-white/10" />

                  <div className="mt-4">
                    <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                      <StatDisplay label="Price" value={`£${selectedPlayer?.price.toFixed(1)}m`} />
                      <StatDisplay label="Sel. by" value={selectedPlayer?.selectionPercent || ''} />
                      <StatDisplay label="xPts" value={selectedPlayer?.predictedPoints.toFixed(1) || ''} />
                      <StatDisplay label="Form" value={selectedPlayer?.form.toFixed(1) || ''} />
                      <StatDisplay label="Goals" value={selectedPlayer?.stats.goals || ''} />
                      <StatDisplay label="Assists" value={selectedPlayer?.stats.assists || ''} />
                      <StatDisplay label="Bonus" value={selectedPlayer?.stats.bonus || ''} />
                      <StatDisplay label="Points" value={selectedPlayer?.stats.points || ''} />
                    </div>
                  </div>

                  <Separator className="bg-white/10 my-4" />

                  <div>
                    <h3 className="text-lg font-semibold mb-2">AI Analysis</h3>
                    <p className="text-white/80 text-sm">{selectedPlayer?.analysis}</p>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
/** Player image component for predictor page */
function PlayerImageComponent({ 
  playerId, 
  playerName, 
  teamName 
}: { 
  playerId: number; 
  playerName: string; 
  teamName: string; 
}) {
  const [currentSrcIndex, setCurrentSrcIndex] = useState(0);
  
  // Build sources array: player images first, then jersey fallback, then placeholder
  const sources = React.useMemo(() => {
    const playerImageSources = getPlayerImageSources(playerId);
    const jerseySource = `/Kits/PLAYER/${teamName}.webp`;
    
    return [
      ...playerImageSources,
      jerseySource,
      "/placeholder.svg"
    ];
  }, [playerId, teamName]);
  
  const currentSrc = sources[currentSrcIndex];
  const isPlayerImage = currentSrcIndex < getPlayerImageSources(playerId).length;
  
  const handleImageError = () => {
    if (currentSrcIndex < sources.length - 1) {
      setCurrentSrcIndex(currentSrcIndex + 1);
    }
  };
  
  return (
    <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center overflow-hidden">
      <img
        src={currentSrc}
        alt={isPlayerImage ? playerName : teamName}
        className={`${
          isPlayerImage 
            ? 'w-10 h-10 rounded-full object-cover' 
            : 'w-8 h-8 object-contain'
        }`}
        onError={handleImageError}
      />
    </div>
  );
}
